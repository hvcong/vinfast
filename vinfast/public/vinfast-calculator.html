<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C√¥ng c·ª• t√≠nh gi√° xe VinFast</title>
   <!-- Swiper CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />

  <!-- Swiper CSS removed (image modal disabled) -->

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
      background: #f5f5f5;
      padding: 16px;
      min-height: 100vh;
      color: #333;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
    }

    /* View Toggle Button */
    .view-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: white;
      border: 2px solid #3182ce;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #3182ce;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      transition: all 0.3s;
    }

    @media (max-width: 1023px) {
      .view-toggle {
        display: none;
      }
    }

    .view-toggle:hover {
      background: #3182ce;
      color: white;
    }

    /* Desktop Layout */
    @media (min-width: 1024px) {
      .container {
        max-width: 1400px;
        padding: 0 20px;
      }

      body.mobile-view .container {
        max-width: 600px;
      }


    }

    .content-grid {
      display: grid;
      gap: 20px;
    }

    /* Mobile Layout - Single column, keep original order */
    @media (max-width: 1023px) {

      .top-content,
      .bot-content {
        flex-direction: column;
      }

      .top-content>*,
      .bot-content>* {
        width: 100%;
      }
    }

    /* Mobile view on desktop */
    body.mobile-view .top-content,
    body.mobile-view .bot-content {
      flex-direction: column;
    }

    body.mobile-view .top-content>*,
    body.mobile-view .bot-content>* {
      width: 100%;
    }

    .top-content,
    .bot-content {
      display: flex;
      gap: 20px;
      width: 100%;
    }

    .top-content>*,
    .bot-content>* {
      flex: 1;
      width: 50%;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .logo {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .logo-icon {
      width: 100px;
      height: 100px;
      border-radius: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .logo-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .logo-text {
      font-size: 10px;
      font-weight: 600;
      color: #333;
      margin-top: 2px;
    }

    .header-title {
      flex: 1;
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-left: 20px;
    }

    .header-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary {
      background: #4a5568;
      color: white;
    }

    .btn-secondary:hover {
      background: #2d3748;
    }

    .btn-primary {
      background: #3182ce;
      color: white;
    }

    .btn-primary:hover {
      background: #2c5aa0;
    }

    /* Main Card */
    .main-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .car-image-container {
      width: 100%;
      aspect-ratio: 1.8;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
      background: #fff;
      position: relative;
    }

    .car-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      transition: all 0.25s ease-in-out;
      border-radius: 8px;
    }

    @media (max-width: 1023px) {
      .car-image {
        object-fit: contain;
        object-position: center center;
      }
    }

    /* Image display and Swiper styles removed (image UI disabled) */
  .car-image.fade-out {
        opacity: 0;
      }

      .car-image.fade-in {
        opacity: 1;
      }

      /* Slide animation for exterior (left side) */
      #carImageExterior.fade-out {
        opacity: 0;
        transform: translateX(-30px);
      }

      #carImageExterior.fade-in {
        opacity: 1;
        transform: translateX(0);
        animation: slideInFromLeft 0.3s ease-out;
      }

      @keyframes slideInFromLeft {
        0% {
          opacity: 0;
          transform: translateX(-30px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      /* Slide animation for interior (right side) */
      #carImageInterior.fade-out {
        opacity: 0;
        transform: translateX(30px);
      }

      #carImageInterior.fade-in {
        opacity: 1;
        transform: translateX(0);
        animation: slideInFromRight 0.3s ease-out;
      }

      @keyframes slideInFromRight {
        0% {
          opacity: 0;
          transform: translateX(30px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .car-image:hover {
        cursor: pointer;
        opacity: 0.85;
        transition: opacity 0.2s ease;
      }

      /* Swiper customization */
      .swiper {
        width: 100%;
        height: 100%;
      }

      .swiper-slide {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .swiper-button-next,
      .swiper-button-prev {
        color: white !important;
        background: rgba(255, 255, 255, 0.9);
        width: 50px !important;
        height: 50px !important;
        border-radius: 50%;
        transition: all 0.3s ease;
      }

      .swiper-button-next:after,
      .swiper-button-prev:after {
        font-size: 24px !important;
        color: #333 !important;
        font-weight: bold;
      }

      .swiper-button-next:hover,
      .swiper-button-prev:hover {
        background: white;
        transform: scale(1.1);
      }

      .swiper-pagination-bullet {
        background: white !important;
        opacity: 0.5;
        width: 10px !important;
        height: 10px !important;
      }

      .swiper-pagination-bullet-active {
        opacity: 1 !important;
        background: white !important;
      }

      /* Image Modal */
      .image-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease;
      }

      .image-modal.active {
        display: flex;
      }

      .image-modal-content {
        position: relative;
        width: 90%;
        height: 90%;
        animation: zoomIn 0.3s ease;
      }

      .image-modal .swiper {
        width: 100%;
        height: 100%;
      }

      .image-modal .swiper-slide img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
    /* Image modal image rules removed */

    .image-modal-close {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      color: white;
      cursor: pointer;
      font-weight: 300;
      z-index: 10000;
      transition: transform 0.2s ease;
    }

    .image-modal-close:hover {
      transform: scale(1.1);
    }

    .image-modal-label {
      position: fixed;
      bottom: 50px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      color: #333;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 10001;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .car-brand-text {
      position: absolute;
      bottom: 10px;
      left: 10px;
      font-size: 12px;
      font-weight: 600;
      color: #333;
      background: rgba(255, 255, 255, 0.9);
      padding: 4px 8px;
      border-radius: 4px;
    }

    .config-section {
      margin-bottom: 24px;
    }

    .config-title {
      font-size: 14px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 12px;
    }

    .dropdown-group {
      display: flex;
      gap: 12px;
    }

    .dropdown-wrapper {
      flex: 1;
      position: relative;
    }

    .dropdown {
      width: 100%;
      padding: 12px 16px;
      background: #4a5568;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 16px center;
      padding-right: 40px;
    }

    .dropdown option {
      background: white;
      color: #333;
    }

    /* Color Picker */
    .color-picker {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      padding: 8px 0;
    }

    .color-option {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
      position: relative;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .color-option img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .color-option:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    }

    .color-option.selected {
      border-color: #3182ce;
      box-shadow: 0 0 0 1px #3182ce, 0 2px 8px rgba(49, 130, 206, 0.3);
      transform: scale(1.03);
    }

    .color-option-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 10px;
      padding: 4px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .color-option:hover .color-option-label {
      opacity: 1;
    }

    /* Hidden select for form compatibility */
    .color-select-hidden {
      display: none;
    }

    /* Radio Buttons */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radio-item input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #3182ce;
    }

    .radio-item label {
      font-size: 14px;
      color: #333;
      cursor: pointer;
    }

    /* Version Radio Buttons - Enhanced style */
    .version-radio-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }

    .version-radio-item:hover {
      border-color: #3182ce;
      background: #f7fafc;
    }

    .version-radio-item.selected {
      border-color: #3182ce;
      background: #ebf8ff;
    }

    .version-radio-item input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #3182ce;
      margin-right: 12px;
    }

    .version-radio-content {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .version-radio-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }

    .version-radio-price {
      font-size: 14px;
      font-weight: 600;
      color: #3182ce;
    }

    .version-radio-item.selected .version-radio-label {
      font-weight: 600;
      color: #3182ce;
    }

    /* Loan Section */
    .loan-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
    }

    .loan-title {
      font-size: 16px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 20px;
    }

    .loan-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .loan-option:last-child {
      border-bottom: none;
    }

    .loan-label {
      font-size: 14px;
      font-weight: 500;
      color: #333;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e0;
      transition: 0.3s;
      border-radius: 24px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: 0.3s;
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: #3182ce;
    }

    .toggle-switch input:checked+.toggle-slider:before {
      transform: translateX(24px);
    }

    /* Slider */
    .slider-container {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .slider-wrapper {
      flex: 1;
    }

    .slider {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: #e2e8f0;
      outline: none;
      -webkit-appearance: none;
      appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3182ce;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #3182ce;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .slider-value {
      font-size: 14px;
      font-weight: 600;
      color: #3182ce;
      min-width: 120px;
      text-align: right;
    }

    /* Customer Info & Cost Estimation */
    .customer-info-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 2px solid #e2e8f0;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      transition: all 0.3s;
    }

    .form-input:focus {
      outline: none;
      border-color: #3182ce;
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }

    .date-input-wrapper {
      position: relative;
    }

    .date-icon {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: #718096;
    }

    /* Cost Breakdown */
    .cost-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }

    .cost-row:last-child {
      border-bottom: none;
    }

    .cost-label {
      color: #4a5568;
      font-weight: 500;
    }

    .cost-value {
      color: #1a1a1a;
      font-weight: 600;
    }

    .cost-total {
      font-size: 20px;
      font-weight: 700;
      color: #3182ce;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 2px solid #e2e8f0;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #3182ce;
    }

    .checkbox-group label {
      font-size: 14px;
      color: #333;
      cursor: pointer;
      flex: 1;
    }

    .discount-value {
      color: #e53e3e;
      font-weight: 600;
    }

    /* Loan Details */
    .loan-details {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e2e8f0;
    }

    .loan-detail-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 0;
      font-size: 14px;
    }

    .loan-detail-label {
      color: #4a5568;
      font-weight: 500;
    }

    .loan-detail-value {
      color: #1a1a1a;
      font-weight: 600;
    }

    .monthly-payment {
      font-size: 20px;
      font-weight: 700;
      color: #3182ce;
      padding-top: 16px;
      margin-top: 16px;
      border-top: 2px solid #e2e8f0;
    }

    /* Hide on mobile */
    @media (max-width: 1023px) {
      /* No longer need desktop-only hiding */
    }

    /* Show on desktop */
    @media (min-width: 1024px) {
      .mobile-only {
        display: none;
      }

      body:not(.mobile-view) .desktop-only {
        display: block;
      }
    }
  </style>
</head>

<body>
  <!-- View Toggle Button -->
  <button class="view-toggle" id="viewToggle">üñ•Ô∏è Desktop View</button>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo">
        <div class="logo-icon">
          <img src="images/logo.jpg" alt="VinFast Logo" />
        </div>
      </div>
      <div class="header-title">C√¥ng c·ª• t√≠nh gi√° xe VinFast</div>
    </div>

    <!-- Content Grid (Desktop) / Single Column (Mobile) -->
    <div class="content-grid">
      <!-- Left Column - Customer Info & Cost Estimation -->
      <div class="top-content">
        <!-- Customer Info Card -->
        <div class="customer-info-card">
          <div class="card-title">Th√¥ng tin kh√°ch h√†ng & Giao d·ªãch</div>

          <div class="form-group">
            <label class="form-label">H·ªç t√™n kh√°ch h√†ng</label>
            <input type="text" class="form-input" id="customerName" placeholder="Nh·∫≠p h·ªç t√™n" />
          </div>

          <div class="form-group">
            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="tel" class="form-input" id="customerPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" />
          </div>

          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="customerEmail" placeholder="Nh·∫≠p email" />
          </div>

          <div class="form-group">
            <label class="form-label">ƒê·ªãa ch·ªâ</label>
            <input type="text" class="form-input" id="customerAddress" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" />
          </div>

          <div class="form-group">
            <label class="form-label">Lo·∫°i kh√°ch h√†ng</label>
            <select class="form-input" id="customerType" style="cursor: pointer">
              <option value="ca_nhan">C√° nh√¢n</option>
              <option value="cong_ty">C√¥ng ty</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Lo·∫°i s·ª≠ d·ª•ng</label>
            <select class="form-input" id="businessType" style="cursor: pointer">
              <option value="khong_kinh_doanh">Kh√¥ng kinh doanh</option>
              <option value="kinh_doanh">Kinh doanh</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">S·ªë ti·ªÅn c·ªçc</label>
            <input type="number" class="form-input" id="depositAmount" value="0" min="0" readonly />
          </div>

          <div class="form-group">
            <label class="form-label">Ng√†y nh·∫≠n c·ªçc</label>
            <div class="date-input-wrapper">
              <input type="date" class="form-input" id="depositDate" />
              <span class="date-icon">üìÖ</span>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Ng√†y h·∫πn giao xe</label>
            <div class="date-input-wrapper">
              <input type="date" class="form-input" id="deliveryDate" />
              <span class="date-icon">üìÖ</span>
            </div>
          </div>
        </div>

        <!-- Main Configuration Card -->
        <div class="main-card">
          <!-- Product images removed: image UI disabled -->
             <!-- Car Image -->
            <div
              class="car-image-container"
              style="position: relative; overflow: hidden"
            >
              <div style="height: 100%">
                <div
                  style="
                    position: relative;
                    background-color: #333;
                    overflow: hidden;
                    height: 100%;
                  "
                >
                  <img
                    src="images/vf7_eco_exterior.jpg"
                    alt="Ngo·∫°i th·∫•t"
                    class="car-image"
                    id="carImageExterior"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                  <div
                    style="
                      position: absolute;
                      bottom: 8px;
                      left: 8px;
                      background: rgba(0, 0, 0, 0.6);
                      color: white;
                      padding: 4px 8px;
                      border-radius: 4px;
                      font-size: 12px;
                    "
                  >
                    Ngo·∫°i th·∫•t
                  </div>
                </div>
                <div style="display: none">
                  <img
                    src="images/vf7_eco_interior.jpg"
                    alt="N·ªôi th·∫•t"
                    class="car-image"
                    id="carImageInterior"
                    style="width: 100%; height: 100%; object-fit: cover"
                  />
                </div>
              </div>
            </div>
          <!-- Configuration Sections -->
          <div class="config-section">
            <div class="config-title">1. Ch·ªçn m·∫´u xe</div>
            <div class="dropdown-wrapper">
              <select class="dropdown" id="carModel">
                <!-- Options will be populated dynamically from database -->
              </select>
            </div>
          </div>

          <div class="config-section">
            <div class="config-title">2. Ch·ªçn phi√™n b·∫£n</div>
            <div class="radio-group" id="carVersionRadioGroup">
              <!-- Radio options will be populated dynamically based on selected car model -->
            </div>
            <!-- Hidden select for backward compatibility -->
            <select style="display: none;" id="carVersion"></select>
          </div>

          <div class="config-section">
            <div style="margin-bottom: 20px">
              <div class="config-title">3. Ngo·∫°i th·∫•t</div>

              <select class="color-select-hidden" id="exteriorColor">
                <!-- Hidden select for form compatibility -->
              </select>

              <div class="color-picker" id="exteriorColorPicker"></div>

            </div>

            <div style="margin-bottom: 20px">
              <div class="config-title">4. N·ªôi th·∫•t</div>

              <select class="color-select-hidden" id="interiorColor">
                <!-- Hidden select for form compatibility -->
              </select>

              <div class="color-picker" id="interiorColorPicker"></div>
            </div>
          </div>

          <div class="config-section">
            <div class="config-title">5. Ch·ªçn n∆°i ƒëƒÉng k√Ω bi·ªÉn s·ªë</div>
            <div class="dropdown-wrapper">
              <select class="dropdown" id="registrationLocation">
                <option value="hcm">TP. H·ªì Ch√≠ Minh</option>
                <option value="other">T·ªânh th√†nh kh√°c</option>
              </select>
            </div>
          </div>

          <!-- Mobile-only customer/business selectors (shown on small screens) -->
          <div class="config-section mobile-only">
            <div class="config-title">4. Lo·∫°i kh√°ch h√†ng & S·ª≠ d·ª•ng</div>
            <div style="display:flex; gap:12px;">
              <div class="dropdown-wrapper" style="flex:1;">
                <select class="dropdown" id="customerTypeMobile">
                  <option value="ca_nhan">C√° nh√¢n</option>
                  <option value="cong_ty">C√¥ng ty</option>
                </select>
              </div>
              <div class="dropdown-wrapper" style="flex:1;">
                <select class="dropdown" id="businessTypeMobile">
                  <option value="khong_kinh_doanh">Kh√¥ng kinh doanh</option>
                  <option value="kinh_doanh">Kinh doanh</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Car Configuration & Loan Details -->
      <div class="bot-content">
        <!-- Cost Estimation Card -->
        <div class="customer-info-card">
          <div class="card-title" id="costEstimationTitle">
            D·ª± to√°n chi ph√≠ cho VF 7 Ti√™u chu·∫©n
          </div>

          <div class="cost-row">
            <span class="cost-label">Gi√° xe (g·ªìm VAT)</span>
            <span class="cost-value" id="carPriceWithVAT">0</span>
          </div>

          <!-- <div class="cost-row">
            <span class="cost-label">T·ªïng gi√° tr·ªã xe</span>
            <span class="cost-value" id="totalCarValue">0</span>
          </div> -->

          <div style="margin: 16px 0">
            <div class="form-label">Ch·ªçn ∆∞u ƒë√£i √°p d·ª•ng</div>
            <!-- VN3 discount removed per request -->
            <div class="checkbox-group">
              <input type="checkbox" id="discount3" />
              <label for="discount3">∆Øu ƒë√£i L√°i xe Xanh (VN3)</label>
              <span class="discount-value" id="discount3Value">-0 ‚Ç´</span>
            </div>
            <div class="checkbox-group">
              <input type="checkbox" id="discount2" data-discount="50000000" />
              <label for="discount2">∆Øu ƒë√£i th√°ng 10</label>
              <span class="discount-value" id="discount2Value">-0 ‚Ç´</span>
            </div>
          </div>

          <div class="cost-row">
            <span class="cost-label">Gi√° sau ∆∞u ƒë√£i</span>
            <span class="cost-value" id="priceAfterDiscount">0</span>
          </div>

          <div style="margin-top: 20px">

            <!-- XƒÉng -> ƒêi·ªán checkbox (uses ho_tro_doi_xe from database.js) -->


             <!-- VinClub Voucher -->
            <div style="margin-top: 12px">
              <label class="form-label">Voucher VinClub</label>
              <div style="
                    display: flex;
                    gap: 16px;
                    justify-content: space-between;
                  ">
                <select class="form-input" id="vinClubVoucher" style="cursor: pointer; width: fit-content">
                  <option value="none">Kh√¥ng √°p d·ª•ng</option>
                  <option value="gold">Gold (0.5%)</option>
                  <option value="platinum">Platinum (1%)</option>
                  <option value="diamond">Diamond (1.5%)</option>
                </select>
                <div class="discount-value" id="vinClubDiscountValue">0</div>
              </div>
            </div>

            <div class="cost-row">
              <div class="checkbox-group">
                <input type="checkbox" id="convertCheckbox" />
                <label for="convertCheckbox">XƒÉng ‚Üí ƒêi·ªán (√°p d·ª•ng chi ph√≠ ƒë·ªïi)</label>
              </div>
              <span class="cost-value" id="convertSupportFee">0 ‚Ç´</span>
            </div>

            <div class="form-label" style="font-weight: 600; margin-bottom: 12px;margin-top: 12px">
              Chi ph√≠ lƒÉn b√°nh d·ª± t√≠nh
            </div>

            <div class="cost-row">
              <span class="cost-label">Ph√≠ bi·ªÉn s·ªë (TP. H·ªì Ch√≠ Minh)</span>
              <span class="cost-value" id="plateFee">20.000.000 ‚Ç´</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">Ph√≠ l∆∞u h√†nh ƒë∆∞·ªùng b·ªô (1 nƒÉm)</span>
              <span class="cost-value" id="roadFee">1.560.000 ‚Ç´</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">B·∫£o hi·ªÉm TNDS (1 nƒÉm)</span>
              <span class="cost-value" id="liabilityInsurance">480.700 ‚Ç´</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">Ph√≠ ƒëƒÉng ki·ªÉm</span>
              <span class="cost-value" id="inspectionFee">90.000 ‚Ç´</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">B·∫£o hi·ªÉm th√¢n v·ªè</span>
              <span class="cost-value" id="bodyInsurance">0</span>
            </div>
            <div class="cost-row">
              <span class="cost-label">Chi ph√≠ d·ªãch v·ª• ƒëƒÉng k√Ω</span>
              <span class="cost-value" id="registrationFee">3.900.000 ‚Ç´</span>
            </div>

            <div class="cost-row">
              <span class="cost-label">T·ªïng chi ph√≠ lƒÉn b√°nh</span>
              <span class="cost-value" id="totalOnRoadCost">38.780.700 ‚Ç´</span>
            </div>
          </div>

          <div class="cost-row cost-total">
            <span>T·ªîNG CHI PH√ç</span>
            <span id="totalCost">888.780.700 ‚Ç´</span>
          </div>
        </div>

        <!-- Loan Options Card -->
        <div class="loan-card">
          <div class="loan-title">T√πy ch·ªçn & Chi ti·∫øt tr·∫£ g√≥p</div>

          <div class="loan-option">
            <span class="loan-label">Vay mua xe tr·∫£ g√≥p</span>
            <label class="toggle-switch">
              <input type="checkbox" id="loanToggle" checked />
              <span class="toggle-slider"></span>
            </label>
          </div>

          <div class="loan-option" id="loanRatioOption">
            <span class="loan-label">T·ª∑ l·ªá vay</span>
            <div class="slider-container">
              <div class="slider-wrapper">
                <input type="range" min="0" max="100" value="70" class="slider" id="loanRatio" />
              </div>
              <input type="number" id="loanRatioNumber" min="0" max="100" value="70" style="width:72px; padding:8px; border-radius:8px; border:1px solid #cbd5e0" />
              <span class="slider-value" id="loanRatioValue">70% gi√° tr·ªã xe</span>
            </div>
          </div>

          <div class="loan-option" id="loanTermOption">
            <span class="loan-label">Th·ªùi h·∫°n vay</span>
            <div class="dropdown-wrapper" style="max-width: 200px">
              <select class="dropdown" id="loanTerm">
                <option value="12">12 th√°ng</option>
                <option value="24">24 th√°ng</option>
                <option value="36">36 th√°ng</option>
                <option value="48">48 th√°ng</option>
                <option value="60" selected>60 th√°ng (5 nƒÉm)</option>
                <option value="72">72 th√°ng</option>
              </select>
            </div>
          </div>

          <div class="loan-option">
            <span class="loan-label">L√£i su·∫•t ng√¢n h√†ng</span>
            <div style="width:120px;">
              <input type="number" id="customInterestRate" placeholder="L√£i su·∫•t (%)" min="0" step="0.01" style="width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e0" />
            </div>
          </div>

          <!-- Loan Details (Desktop) -->
          <div class="loan-details desktop-only">
            <div class="form-label" style="font-weight: 600; margin-bottom: 12px">
              Chi ti·∫øt tr·∫£ g√≥p d·ª± t√≠nh
            </div>

            <div class="loan-detail-row">
              <span class="loan-detail-label">S·ªë ti·ªÅn tr·∫£ tr∆∞·ªõc</span>
              <span class="loan-detail-value" id="downPayment">266.634.210 ‚Ç´</span>
            </div>
            <div class="loan-detail-row">
              <span class="loan-detail-label">S·ªë ti·ªÅn vay</span>
              <span class="loan-detail-value" id="loanAmount">622.146.490 ‚Ç´</span>
            </div>
            <div class="loan-detail-row">
              <span class="loan-detail-label">T·ªïng l√£i ph·∫£i tr·∫£</span>
              <span class="loan-detail-value" id="totalInterest">170.979.967 ‚Ç´</span>
            </div>
            <div class="loan-detail-row monthly-payment">
              <span>G·ªëc & l√£i h√†ng th√°ng</span>
              <span id="monthlyPayment">13.218.774 ‚Ç´</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer Action Buttons -->
    <div class="header-actions" style="margin-top: 20px">
      <button class="btn btn-secondary" id="printBtnFooter">
        In B√°o Gi√° 1
      </button>
      <button class="btn btn-secondary" id="printBtn2Footer">
        In B√°o Gi√° 2
      </button>
      <button class="btn btn-primary" id="emailBtnFooter">
        G·ª≠i Email B√°o Gi√°
      </button>
    </div>
  </div>



  <!-- Image modal removed (image UI disabled) -->

  <!-- Import vinfast_images_metadata.js FIRST - Required by database.js -->
  <script src="vinfast_images_metadata.js"></script>

  <!-- Import database.js SECOND - Depends on vinfast_images_metadata -->
  <script src="database.js"></script>

  <script>
    // View Toggle
    const viewToggle = document.getElementById("viewToggle");
    const isDesktop = window.innerWidth >= 1024;

    // Set initial view based on screen size
    if (isDesktop && !localStorage.getItem("mobileView")) {
      document.body.classList.remove("mobile-view");
      viewToggle.textContent = "üì± Mobile View";
    } else {
      document.body.classList.add("mobile-view");
      viewToggle.textContent = "üñ•Ô∏è Desktop View";
    }

    viewToggle.addEventListener("click", function () {
      document.body.classList.toggle("mobile-view");
      if (document.body.classList.contains("mobile-view")) {
        this.textContent = "üñ•Ô∏è Desktop View";
        localStorage.setItem("mobileView", "true");
      } else {
        this.textContent = "üì± Mobile View";
        localStorage.removeItem("mobileView");
      }
      calculateAll();
    });

    // Helper function to get data from database.js
    function getDataByKey(array, key, value) {
      const item = array.find((item) => item[key] === value);
      return item || null;
    }

    // Get all data by key (for multiple matches)
    function getAllDataByKey(array, key, value) {
      return array.filter((item) => item[key] === value);
    }


    // Build derived versions from carPriceData (source of truth).
    // This groups entries by model+trim and deduplicates colors.
    function buildDerivedVersionsFromCarPriceData() {
      if (typeof carPriceData === 'undefined' || !Array.isArray(carPriceData)) return [];

      const groups = {}; // key = `${model}||${trim}`
      carPriceData.forEach((entry) => {
        // Expect canonical keys: model, trim, exterior_color, interior_color, price_vnd
        const model = String(entry.model || '').trim();
        const trim = String(entry.trim || '').trim();
        if (!model) return;
        const key = model + '||' + trim;
        if (!groups[key]) {
          groups[key] = {
            model: model,
            trim: trim,
            min_price_vnd: Infinity,
            exterior_colors: new Set(),
            interior_colors: new Set()
          };
        }

        const g = groups[key];
        // Use price_vnd only
        const price = Number(entry.price_vnd || 0) || 0;
        if (price > 0 && price < g.min_price_vnd) g.min_price_vnd = price;

        // Use canonical color keys only
        const ext = entry.exterior_color;
        if (ext) g.exterior_colors.add(String(ext).trim());

        const interior = entry.interior_color;
        if (interior) g.interior_colors.add(String(interior).trim());

        // image_interior removed: image UI disabled and related data not used
      });
      return Object.keys(groups).map((k) => {
        const v = groups[k];
        return {
          model: v.model,
          trim: v.trim,
          price_vnd: v.min_price_vnd === Infinity ? 0 : v.min_price_vnd,
          exterior_colors: Array.from(v.exterior_colors),
          interior_colors: Array.from(v.interior_colors),
          // image_interior intentionally omitted
        };
      });
    }

    // Derived versions built from carPriceData (source of truth)
    // Initialize empty and build after database is confirmed loaded to avoid race conditions
    let derivedVersions = [];

    // Get unique car models from derivedVersions (built from carPriceData)
    function getCarModels() {
      const uniqueModels = {};
      derivedVersions.forEach((xe) => {
        if (!uniqueModels[xe.model]) {
          uniqueModels[xe.model] = xe.model;
        }
      });
      return uniqueModels;
    }

    // Populate car models dropdown from derivedVersions
    function populateCarModels() {
      const carModelSelect = document.getElementById("carModel");
      if (!carModelSelect) return null;
      carModelSelect.innerHTML = "";

      const models = getCarModels();
      let firstModel = null;

      Object.keys(models).forEach((modelKey, index) => {
        const option = document.createElement("option");
        option.value = modelKey;
        option.textContent = models[modelKey];

        if (index === 0) {
          option.selected = true;
          firstModel = modelKey;
        }

        carModelSelect.appendChild(option);
      });

      return firstModel;
    }

    // Map location to database key
    const locationMap = {
      hcm: "ho_chi_minh",
      hanoi: "ha_noi",
      danang: "da_nang",
      cantho: "can_tho",
      haiphong: "hai_phong",
      other: "tinh_khac",
    };

    // Populate car versions based on selected model (from derivedVersions)
    function populateCarVersions(carModel, keepCurrentColor = false) {
      const versionSelect = document.getElementById("carVersion");
      if (!versionSelect) return;
      versionSelect.style.display = "";
      versionSelect.className = "dropdown";
      versionSelect.innerHTML = "";

      const versions = derivedVersions.filter(v => v.model === carModel);

        if (versions.length > 0) {
        versions.forEach((version, index) => {
          const option = document.createElement("option");
          // Use trim as the option value/label; fall back to model if trim is empty
          option.value = (version.trim && String(version.trim).trim() !== "") ? String(version.trim).trim() : "";
          option.textContent = (version.trim && String(version.trim).trim() !== "") ? String(version.trim).trim() : version.model;
          option.dataset.price = version.price_vnd || version.min_price_vnd || 0;
          // Always store the real model name for derived data matching
          option.dataset.modelName = version.model || '';
          // Prefer legacy dong_xe code for dataset.carModel so lookups into
          // thong_tin_ky_thuat_xe and other legacy tables work correctly.
          try {
            let dongCode = null;
            if (typeof danh_sach_xe !== 'undefined' && Array.isArray(danh_sach_xe)) {
              const modelName = (version.model || '').toString().trim().toLowerCase();
              const found = danh_sach_xe.find(x => (x.ten_hien_thi || '').toString().trim().toLowerCase() === modelName);
              if (found && found.dong_xe) dongCode = found.dong_xe;
              if (!dongCode && modelName) {
                const norm = modelName.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                const found2 = danh_sach_xe.find(x => x.dong_xe === norm || x.dong_xe === norm.replace(/__+/g, '_'));
                if (found2 && found2.dong_xe) dongCode = found2.dong_xe;
              }
            }
            option.dataset.carModel = dongCode || version.model || '';
          } catch (e) {
            option.dataset.carModel = version.model || '';
          }
          if (index === 0) option.selected = true;
          versionSelect.appendChild(option);
        });

        // Populate colors
        populateColorOptions(keepCurrentColor);
      } else {
        const option = document.createElement("option");
        option.value = "standard";
        option.textContent = "Ti√™u chu·∫©n";
        option.dataset.price = "0";
        option.dataset.carModel = carModel || "";
        option.selected = true;
        versionSelect.appendChild(option);
      }
    }

    // Populate bank interest preset dropdown from database.js
    function populateBankInterestPresets() {
      const sel = document.getElementById('bankInterestPreset');
      if (!sel || typeof bank_interest_presets === 'undefined' || !Array.isArray(bank_interest_presets)) return;
      sel.innerHTML = '';
      bank_interest_presets.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = `${p.name}`;
        opt.dataset.rate = p.rate;
        sel.appendChild(opt);
      });
      // select default if present
      const defaultOpt = Array.from(sel.options).find(o => o.value === 'default');
      if (defaultOpt) defaultOpt.selected = true;
    }

    // Update car image based on selected exterior color with animation

    // Populate color options (exterior + interior) for selected model/version
    function populateColorOptions(keepCurrentColor = false) {
      const versionSelect = document.getElementById("carVersion");
      const selectedVersion = versionSelect ? versionSelect.value : null;
      // Find matching derived version by model + trim
      const currentModel = getCurrentCarModel();
      const selectedCar = derivedVersions.find(xe => xe.model === currentModel && xe.trim === selectedVersion);
      if (!selectedCar) {
        // clear selects
        const exteriorColorPicker = document.getElementById("exteriorColorPicker");
        if (exteriorColorPicker) {
          exteriorColorPicker.innerHTML = '';
        }
        const interiorColorSelect = document.getElementById("interiorColor");
        if (interiorColorSelect) {
          interiorColorSelect.innerHTML = '<option value="">Kh√¥ng c√≥ th√¥ng tin m√†u n·ªôi th·∫•t</option>';
          interiorColorSelect.dispatchEvent(new Event('change'));
        }
        if (interiorColorPicker) {
          interiorColorPicker.innerHTML = '';
        }
        const interiorColorPicker = document.getElementById("interiorColorPicker");
        if (interiorColorPicker) {
          interiorColorPicker.innerHTML = '';
        }
        return;
      }

      const exteriorColorSelect = document.getElementById("exteriorColor");
      const exteriorColorPicker = document.getElementById("exteriorColorPicker");
      const interiorColorSelect = document.getElementById("interiorColor");
      const interiorColorPicker = document.getElementById("interiorColorPicker");
      const currentExteriorColor = keepCurrentColor && exteriorColorSelect ? exteriorColorSelect.value : null;
      const currentInteriorColor = keepCurrentColor && interiorColorSelect ? interiorColorSelect.value : null;

      if (exteriorColorSelect && exteriorColorPicker) {
        exteriorColorSelect.innerHTML = "";
        exteriorColorPicker.innerHTML = "";
        const firstExt = selectedCar.exterior_colors[0];
        const selectedExt = currentExteriorColor && selectedCar.exterior_colors.includes(currentExteriorColor) ? currentExteriorColor : (typeof firstExt === 'string' ? firstExt : firstExt && firstExt.ma_mau || firstExt);

        // Filter uniqueNgoaiThatColors to only available colors
        const availableColors = uniqueNgoaiThatColors.filter(color => selectedCar.exterior_colors.includes(color.code));

        availableColors.forEach((color) => {
          // Populate hidden select
          const opt = document.createElement('option');
          opt.value = color.code;
          opt.textContent = color.name;
          if (opt.value === selectedExt) opt.selected = true;
          exteriorColorSelect.appendChild(opt);

          // Populate color picker
          const colorDiv = document.createElement('div');
          colorDiv.className = 'color-option';
          if (opt.value === selectedExt) colorDiv.classList.add('selected');
          colorDiv.setAttribute('data-code', color.code);
          colorDiv.innerHTML = `<img src="${color.icon}" alt="${color.name}" />`;
          colorDiv.addEventListener('click', function() {
            // Remove selected from others
            exteriorColorPicker.querySelectorAll('.color-option').forEach(div => div.classList.remove('selected'));
            // Add selected to this
            this.classList.add('selected');
            // Update hidden select
            exteriorColorSelect.value = color.code;
            // Update image
            updateCarImage();
            // Trigger change
            exteriorColorSelect.dispatchEvent(new Event('change'));
          });
          exteriorColorPicker.appendChild(colorDiv);
        });
        exteriorColorSelect.dispatchEvent(new Event('change'));
      }

      if (interiorColorSelect && interiorColorPicker) {
        interiorColorSelect.innerHTML = "";
        interiorColorPicker.innerHTML = "";
        const firstInt = selectedCar.interior_colors[0];
        const selectedInt = currentInteriorColor && selectedCar.interior_colors.includes(currentInteriorColor) ? currentInteriorColor : (typeof firstInt === 'string' ? firstInt : firstInt && firstInt.ten_mau_noi || firstInt);

        // Map interior colors directly to uniqueNoiThatColors by code
        const availableInteriorColors = selectedCar.interior_colors.map(code => {
          return uniqueNoiThatColors.find(c => c.code === code);
        }).filter(c => c);

        availableInteriorColors.forEach((color) => {
          // Populate hidden select
          const opt = document.createElement('option');
          opt.value = color.code;
          opt.textContent = color.name;
          if (opt.value === selectedInt) opt.selected = true;
          interiorColorSelect.appendChild(opt);

          // Populate color picker
          const colorDiv = document.createElement('div');
          colorDiv.className = 'color-option';
          if (opt.value === selectedInt) colorDiv.classList.add('selected');
          colorDiv.setAttribute('data-code', color.code);
          colorDiv.innerHTML = `<img src="${color.icon}" alt="${color.name}" />`;
          colorDiv.addEventListener('click', function() {
            // Remove selected from others
            interiorColorPicker.querySelectorAll('.color-option').forEach(div => div.classList.remove('selected'));
            // Add selected to this
            this.classList.add('selected');
            // Update hidden select
            interiorColorSelect.value = color.code;
            // Trigger change
            interiorColorSelect.dispatchEvent(new Event('change'));
          });
          interiorColorPicker.appendChild(colorDiv);
        });
        interiorColorSelect.dispatchEvent(new Event('change'));
      }
    }

    // Update car image based on selected exterior color with animation
    function updateCarImage() {
      const modelSelect = document.getElementById('carModel');
      const versionSelect = document.getElementById('carVersion');
      const exteriorSelect = document.getElementById('exteriorColor');

      const model = modelSelect ? modelSelect.value : '';
      const version = versionSelect ? versionSelect.value : '';
      const exterior = exteriorSelect ? exteriorSelect.value : '';

      const exteriorImg = document.getElementById("carImageExterior");

      // If no color is selected yet, don't update images
      if (!exterior) {
        console.warn("No exterior color selected yet, skipping image update");
        return;
      }

      // Remove any existing animation classes first
      exteriorImg.classList.remove("fade-out", "fade-in");

      // Force reflow to restart animation
      void exteriorImg.offsetWidth;

      // Add fade-out effect
      exteriorImg.classList.add("fade-out");

      // Wait for fade-out animation to complete completely, then change image
      setTimeout(() => {
        if (typeof carPriceData === 'undefined' || !Array.isArray(carPriceData)) return;

        // Find exact match
        const exact = carPriceData.find(e => {
          const m = String(e.model || '').trim();
          const t = String(e.trim || '').trim();
          const ext = String(e.exterior_color || '').trim();
          return m === model && t === version && ext === exterior;
        });

        if (exact && exact.car_image_url) {
          exteriorImg.src = exact.car_image_url;
        } else {
          // Fallback: find any image for this model/version combination
          const fallback = carPriceData.find(e => {
            const m = String(e.model || '').trim();
            const t = String(e.trim || '').trim();
            return m === model && t === version && e.car_image_url;
          });
          if (fallback && fallback.car_image_url) {
            exteriorImg.src = fallback.car_image_url;
          }
        }

        // Wait a bit for image to load, then fade-in
        setTimeout(() => {
          exteriorImg.classList.remove("fade-out");
          exteriorImg.classList.add("fade-in");

          // Clean up animation class after animation completes
          setTimeout(() => {
            exteriorImg.classList.remove("fade-in");
          }, 300); // Match animation duration
        }, 50);
      }, 250); // Wait for fade-out to complete (match transition duration)
    }

    // Get car price from selected model/version/colors. Prefer exact match in carPriceData.
    function getCarPrice() {
      const modelSelect = document.getElementById('carModel');
      const versionSelect = document.getElementById('carVersion');
      const exteriorSelect = document.getElementById('exteriorColor');
      const interiorSelect = document.getElementById('interiorColor');

      const model = modelSelect ? modelSelect.value : '';
      const version = versionSelect ? versionSelect.value : '';
      const exterior = exteriorSelect ? exteriorSelect.value : '';
      const interior = interiorSelect ? interiorSelect.value : '';

      if (typeof carPriceData === 'undefined' || !Array.isArray(carPriceData)) {
        // fallback to dataset price on version option
        if (versionSelect && versionSelect.options.length > 0) {
          const sel = versionSelect.options[versionSelect.selectedIndex] || versionSelect.options[0];
          const p = parseInt(sel.dataset.price);
          return isNaN(p) ? 0 : p;
        }
        return 0;
      }

      // Try exact match using canonical keys: model, trim, exterior_color, interior_color
      const exact = carPriceData.find(e => {
        const m = String(e.model || '').trim();
        const t = String(e.trim || '').trim();
        const ext = String(e.exterior_color || '').trim();
        const inti = String(e.interior_color || '').trim();
        return m === model && t === version && ext === exterior && inti === interior;
      });
      if (exact && typeof exact.price_vnd !== 'undefined') return Number(exact.price_vnd);

      // If no exact match, match by model+trim and return minimal price_vnd among candidates
      const candidates = carPriceData.filter(e => {
        const m = String(e.model || '').trim();
        const t = String(e.trim || '').trim();
        return m === model && t === version;
      });
      if (candidates.length > 0) {
        const prices = candidates.map(c => Number(c.price_vnd || 0) || 0).filter(p => p > 0);
        if (prices.length > 0) return Math.min(...prices);
      }

      // Last resort: dataset price on version option
      if (versionSelect && versionSelect.options.length > 0) {
        const sel = versionSelect.options[versionSelect.selectedIndex] || versionSelect.options[0];
        const p = parseInt(sel.dataset.price);
        return isNaN(p) ? 0 : p;
      }

      return 0;
    }

    // Get current car model key (safe fallback)
    function getCurrentCarModel() {
      const versionSelect = document.getElementById("carVersion");
      const carModelSelect = document.getElementById("carModel");
      let carModel = '';
      if (versionSelect && versionSelect.options && versionSelect.options.length > 0) {
        const sel = versionSelect.options[versionSelect.selectedIndex] || versionSelect.options[0];
        // Prefer the real model name stored on the option for derivedVersions matching
        carModel = (sel && sel.dataset && sel.dataset.modelName) || (sel && sel.dataset && sel.dataset.carModel) || '';
      }
      if (!carModel && carModelSelect) carModel = carModelSelect.value || '';
      return carModel;
    }

    // Return legacy dong_xe code for lookups into legacy tables (thong_tin_ky_thuat_xe, ho_tro_doi_xe, etc.)
    function getSelectedDongXe() {
      const versionSelect = document.getElementById("carVersion");
      const carModelSelect = document.getElementById("carModel");
      let dong = '';
      if (versionSelect && versionSelect.options && versionSelect.options.length > 0) {
        const sel = versionSelect.options[versionSelect.selectedIndex] || versionSelect.options[0];
        dong = (sel && sel.dataset && sel.dataset.carModel) || '';
      }
      // If we don't have dataset.carModel, try to map from carModelSelect.value using danh_sach_xe
      if (!dong && carModelSelect && typeof danh_sach_xe !== 'undefined' && Array.isArray(danh_sach_xe)) {
        const modelName = (carModelSelect.value || '').toString().trim().toLowerCase();
        const found = danh_sach_xe.find(x => (x.ten_hien_thi || '').toString().trim().toLowerCase() === modelName);
        if (found && found.dong_xe) dong = found.dong_xe;
        if (!dong && modelName) {
          const norm = modelName.replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
          const found2 = danh_sach_xe.find(x => x.dong_xe === norm || x.dong_xe === norm.replace(/__+/g, '_'));
          if (found2 && found2.dong_xe) dong = found2.dong_xe;
        }
      }
      return dong || '';
    }

    // Get deposit amount from gia_tri_dat_coc based on dong_xe
    function getDepositAmount(dongXe) {
      if (!dongXe || typeof gia_tri_dat_coc === 'undefined' || !Array.isArray(gia_tri_dat_coc)) {
        return 0;
      }
      const depositData = gia_tri_dat_coc.find(item => item.dong_xe === dongXe);
      return depositData ? depositData.gia_tri : 0;
    }

    // Update deposit amount field automatically
    function updateDepositAmount() {
      const dongXe = getSelectedDongXe();
      const depositAmount = getDepositAmount(dongXe);
      const depositInput = document.getElementById("depositAmount");
      if (depositInput) {
        depositInput.value = depositAmount;
      }
    }

    // Format currency
    function formatCurrency(amount) {
      return new Intl.NumberFormat("vi-VN").format(amount) + " ‚Ç´";
    }

    // Calculate all costs
    function calculateAll() {

      const carModel = document.getElementById("carModel").value;
      const carVersion = document.getElementById("carVersion").value;
      const registrationLocation = document.getElementById(
        "registrationLocation"
      ).value;


      // Get base price from selected version
      const basePrice = getCarPrice();

      // Calculate discounts - Using data from database.js or data attributes
  const discount2Element = document.getElementById("discount2");
  const discount3Element = document.getElementById("discount3");

  const discount2Potential = parseInt(discount2Element?.getAttribute("data-discount") || 0) || 0;
  const discount2 = discount2Element && discount2Element.checked ? discount2Potential : 0;

      const discount3Potential = Math.round(basePrice * 0.04);
      const discount3 = discount3Element && discount3Element.checked ? discount3Potential : 0;

      // Update discount displays (show as negative amounts; default "-0 ‚Ç´" when unchecked)
      // discount1 (VN3) removed; only update discount2/3 displays below
      const discount2ValueEl = document.getElementById("discount2Value");
      if (discount2ValueEl) {
        discount2ValueEl.textContent = (discount2Element && discount2Element.checked)
          ? "-" + formatCurrency(discount2Potential)
          : "-" + formatCurrency(0);
      }
      const discount3ValueEl = document.getElementById("discount3Value");
      if (discount3ValueEl) {
        discount3ValueEl.textContent = (discount3Element && discount3Element.checked)
          ? "-" + formatCurrency(discount3Potential)
          : "-" + formatCurrency(0);
      }

      // XƒÉng -> ƒêi·ªán convert support (if user checks the box) - applied as discount
      const convertChecked = document.getElementById('convertCheckbox') ? document.getElementById('convertCheckbox').checked : false;
      // Use selected dong_xe code for lookup
      let convertSupportDiscount = 0;
      try {
        if (convertChecked && typeof ho_tro_doi_xe !== 'undefined') {
          const dongCode = getSelectedDongXe();
          if (dongCode) {
            const supportEntry = ho_tro_doi_xe.find(h => h.dong_xe === dongCode);
            if (supportEntry && supportEntry.gia_tri) convertSupportDiscount = Number(supportEntry.gia_tri) || 0;
          }
        }
      } catch (e) {
        console.warn('Error computing convert support:', e);
        convertSupportDiscount = 0;
      }

      // Calculate VinClub discount based on price AFTER basic promotions only
  const promotionDiscountTotal = discount2 + discount3;
      const priceAfterBasicPromotions = Math.max(0, basePrice - promotionDiscountTotal);

      const vinClubSelect = document.getElementById("vinClubVoucher");
      const vinClubValue = vinClubSelect ? vinClubSelect.value : "none";
      let vinClubDiscount = 0;
      if (vinClubValue !== "none") {
        const vinClubData = getDataByKey(uu_dai_vin_club, "hang", vinClubValue);
        if (vinClubData) {
          vinClubDiscount = Math.round(priceAfterBasicPromotions * vinClubData.ty_le);
        }
      }

      // Apply convert support discount separately
      const totalDiscount = promotionDiscountTotal + vinClubDiscount + convertSupportDiscount;
      const priceAfterDiscount = Math.max(0, basePrice - totalDiscount);

      // Get car model key for database lookup (legacy dong_xe)
      const carModelKey = getSelectedDongXe();

      // Get customer type for road fee calculation (owner: c√° nh√¢n / c√¥ng ty)
      // and business usage type for insurance (kinh_doanh / khong_kinh_doanh)
      // Try to get from desktop first, if not available use mobile
      const customerTypeDesktop = document.getElementById("customerType");
      const customerTypeMobile = document.getElementById("customerTypeMobile");
      const customerType = customerTypeDesktop
        ? customerTypeDesktop.value
        : customerTypeMobile
          ? customerTypeMobile.value
          : "ca_nhan";

      // Business usage (affects insurance rates). Default to non-business if missing.
      const businessTypeDesktop = document.getElementById("businessType");
      const businessTypeMobile = document.getElementById("businessTypeMobile");
      const businessType = businessTypeDesktop
        ? businessTypeDesktop.value
        : businessTypeMobile
          ? businessTypeMobile.value
          : "khong_kinh_doanh";
      const locationKey = locationMap[registrationLocation] || "tinh_khac";
      const plateFeeData = getDataByKey(
        phi_cap_bien_so,
        "khu_vuc",
        locationKey
      );
      const plateFee = plateFeeData
        ? plateFeeData.gia_tri
        : getDataByKey(phi_cap_bien_so, "khu_vuc", "tinh_khac").gia_tri;

      // Ph√≠ ƒë∆∞·ªùng b·ªô - based on customer type (c√° nh√¢n ho·∫∑c c√¥ng ty)
      const roadFeeData = getDataByKey(phi_duong_bo, "loai", customerType);
      const roadFee = roadFeeData
        ? roadFeeData.gia_tri
        : getDataByKey(phi_duong_bo, "loai", "ca_nhan").gia_tri;

      // Get th√¥ng tin xe for insurance calculation
      const carInfo = getDataByKey(
        thong_tin_ky_thuat_xe,
        "dong_xe",
        carModelKey
      );

      // Ph√≠ TNDS - based on business usage (kinh doanh / kh√¥ng kinh doanh)
      const liabilityInsurance = carInfo
        ? businessType === "khong_kinh_doanh"
          ? carInfo.phi_tnds_ca_nhan
          : carInfo.phi_tnds_kinh_doanh
        : getDataByKey(thong_tin_ky_thuat_xe, "dong_xe", "vf_7")
          .phi_tnds_ca_nhan;
      console.log("Liability Insurance:", liabilityInsurance);

      // Ph√≠ ki·ªÉm ƒë·ªãnh
      const inspectionFee = phi_kiem_dinh;

      // B·∫£o hi·ªÉm th√¢n v·ªè - based on business usage
      const bhvcRate = carInfo
        ? businessType === "khong_kinh_doanh"
          ? carInfo.ty_le_bhvc_ca_nhan
          : carInfo.ty_le_bhvc_kinh_doanh
        : 0.01;

      const bodyInsurance = Math.round(priceAfterDiscount * bhvcRate);

      // Chi ph√≠ d·ªãch v·ª• ƒëƒÉng k√Ω - from database.js
      const registrationFee = chi_phi_dich_vu_dang_ky;

      const totalOnRoadCost =
        plateFee +
        roadFee +
        liabilityInsurance +
        inspectionFee +
        bodyInsurance +
        registrationFee;
      const totalCost = priceAfterDiscount + totalOnRoadCost;


      // Update cost display
      document.getElementById("carPriceWithVAT").textContent =
        formatCurrency(basePrice);
      // document.getElementById("totalCarValue").textContent =
      //   formatCurrency(basePrice);
      document.getElementById("priceAfterDiscount").textContent =
        formatCurrency(priceAfterBasicPromotions);
      document.getElementById("plateFee").textContent =
        formatCurrency(plateFee);

      // Update plate fee label with location name
      const plateFeeLabel = document.querySelector(
        ".cost-row:has(#plateFee) .cost-label"
      );
      if (plateFeeLabel && plateFeeData) {
        plateFeeLabel.textContent = `Ph√≠ bi·ªÉn s·ªë (${plateFeeData.ten_khu_vuc})`;
      }

      document.getElementById("roadFee").textContent =
        formatCurrency(roadFee);
      document.getElementById("liabilityInsurance").textContent =
        formatCurrency(liabilityInsurance);
      document.getElementById("inspectionFee").textContent =
        formatCurrency(inspectionFee);
      document.getElementById("bodyInsurance").textContent =
        formatCurrency(bodyInsurance);
      document.getElementById("registrationFee").textContent =
        formatCurrency(registrationFee);
      // Update convert support fee display (now as discount, but show if applicable)
      const convertEl = document.getElementById('convertSupportFee');
      if (convertEl) convertEl.textContent = formatCurrency(convertSupportDiscount);
      // Update VinClub discount display
      const vinClubEl = document.getElementById('vinClubDiscountValue');
      if (vinClubEl) vinClubEl.textContent = formatCurrency(vinClubDiscount);
      document.getElementById("totalOnRoadCost").textContent =
        formatCurrency(totalOnRoadCost);
      document.getElementById("totalCost").textContent =
        formatCurrency(totalCost);

      // Update title with car model and version
      document.getElementById(
        "costEstimationTitle"
      ).textContent = `D·ª± to√°n chi ph√≠ cho ${carModel} ${carVersion}`;

      // Calculate loan details if enabled
      if (document.getElementById("loanToggle").checked) {
        calculateLoanDetails(totalCost);
      } else {
        document.getElementById("downPayment").textContent =
          formatCurrency(0);
        document.getElementById("loanAmount").textContent = formatCurrency(0);
        document.getElementById("totalInterest").textContent =
          formatCurrency(0);
        document.getElementById("monthlyPayment").textContent =
          formatCurrency(0);
      }
    }

    // Calculate loan details
    function calculateLoanDetails(carPrice) {
      const loanRatio = parseFloat(document.getElementById("loanRatio").value) / 100;
      const loanTerm = parseInt(document.getElementById("loanTerm").value);

      // Choose interest rate from custom input
      let annualRate = lai_suat_vay_hang_nam;
      try {
        const customRateEl = document.getElementById('customInterestRate');
        const custom = customRateEl && customRateEl.value ? Number(customRateEl.value) / 100 : null;
        if (custom && !isNaN(custom) && custom >= 0) {
          annualRate = custom;
        }
      } catch (e) {
        annualRate = lai_suat_vay_hang_nam;
      }

      const monthlyRate = annualRate / 12;

      const loanAmount = Math.round(carPrice * loanRatio);
      const downPayment = carPrice - loanAmount;

      // monthly payment formula (annuity)
      let monthlyPayment = 0;
      if (monthlyRate > 0 && loanTerm > 0) {
        monthlyPayment = (loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, loanTerm))) / (Math.pow(1 + monthlyRate, loanTerm) - 1);
      } else if (loanTerm > 0) {
        monthlyPayment = loanAmount / loanTerm;
      }
      const totalPayment = monthlyPayment * loanTerm;
      const totalInterest = totalPayment - loanAmount;

      document.getElementById("downPayment").textContent = formatCurrency(downPayment);
      document.getElementById("loanAmount").textContent = formatCurrency(loanAmount);
      document.getElementById("totalInterest").textContent = formatCurrency(Math.round(totalInterest));
      document.getElementById("monthlyPayment").textContent = formatCurrency(Math.round(monthlyPayment));
    }

    // Loan ratio slider
    const loanRatioSlider = document.getElementById("loanRatio");
    const loanRatioValue = document.getElementById("loanRatioValue");
  const loanRatioNumber = document.getElementById("loanRatioNumber");

    // sync slider and numeric input
    function setLoanRatioUI(value) {
      const v = Math.max(0, Math.min(100, Number(value) || 0));
      loanRatioSlider.value = v;
      if (loanRatioNumber) loanRatioNumber.value = v;
      loanRatioValue.textContent = `${v}% gi√° tr·ªã xe`;
    }

    loanRatioSlider.addEventListener("input", function () {
      setLoanRatioUI(this.value);
      calculateAll();
    });
    if (loanRatioNumber) {
      loanRatioNumber.addEventListener('input', function() {
        setLoanRatioUI(this.value);
        calculateAll();
      });
    }

    // Loan toggle
    const loanToggle = document.getElementById("loanToggle");
    const loanRatioOption = document.getElementById("loanRatioOption");
    const loanTermOption = document.getElementById("loanTermOption");

    loanToggle.addEventListener("change", function () {
      if (this.checked) {
        loanRatioOption.style.display = "flex";
        loanTermOption.style.display = "flex";
      } else {
        loanRatioOption.style.display = "none";
        loanTermOption.style.display = "none";
      }
      calculateAll();
    });

    // Custom interest change
    const customInterestEl = document.getElementById('customInterestRate');
    if (customInterestEl) customInterestEl.addEventListener('input', calculateAll);

    // Car model and version change
    document
      .getElementById("carModel")
      .addEventListener("change", function () {

        // When changing car model, don't keep current color (reset to default)
        populateCarVersions(this.value, false);
        updateDepositAmount();
        calculateAll();
      });
    document
      .getElementById("carVersion")
      .addEventListener("change", function () {
        // When changing version within same model, try to keep current color
        populateColorOptions(true);
        updateDepositAmount();
        calculateAll();
      });
    document
      .getElementById("registrationLocation")
      .addEventListener("change", calculateAll);

    // Customer type change - sync between desktop and mobile
    const customerTypeDesktop = document.getElementById("customerType");
    const customerTypeMobile = document.getElementById("customerTypeMobile");

    if (customerTypeDesktop) {
      customerTypeDesktop.addEventListener("change", function () {
        if (customerTypeMobile) {
          customerTypeMobile.value = this.value;
        }
        calculateAll();
      });
    }

    if (customerTypeMobile) {
      customerTypeMobile.addEventListener("change", function () {
        if (customerTypeDesktop) {
          customerTypeDesktop.value = this.value;
        }
        calculateAll();
      });
    }

    // Business usage change - sync between desktop and mobile
    const businessTypeDesktop = document.getElementById("businessType");
    const businessTypeMobile = document.getElementById("businessTypeMobile");

    if (businessTypeDesktop) {
      businessTypeDesktop.addEventListener("change", function () {
        if (businessTypeMobile) {
          businessTypeMobile.value = this.value;
        }
        calculateAll();
      });
    }

    if (businessTypeMobile) {
      businessTypeMobile.addEventListener("change", function () {
        if (businessTypeDesktop) {
          businessTypeDesktop.value = this.value;
        }
        calculateAll();
      });
    }

    // Color changes
    document
      .getElementById("exteriorColor")
      .addEventListener("change", function () {
        updateCarImage();
        calculateAll();
      });

    // Interior color dropdown change -> recalc and update interior image if applicable
    document
      .getElementById("interiorColor")
      .addEventListener("change", function () {
        // interior image may change depending on selection (images disabled)
        calculateAll();
      });

    // Discount checkboxes
    // discount1 (VN3) removed
    document
      .getElementById("discount2")
      .addEventListener("change", calculateAll);
    document
      .getElementById("discount3")
      .addEventListener("change", calculateAll);

    // Convert checkbox change -> recalc
    const convertCheckboxEl = document.getElementById('convertCheckbox');
    if (convertCheckboxEl) convertCheckboxEl.addEventListener('change', calculateAll);

    // VinClub voucher dropdown
    const vinClubVoucherElement = document.getElementById("vinClubVoucher");
    if (vinClubVoucherElement) {
      vinClubVoucherElement.addEventListener("change", calculateAll);
    }

    // Loan term change
    document
      .getElementById("loanTerm")
      .addEventListener("change", calculateAll);

    // Function to collect all invoice data
    function collectInvoiceData() {
      // Get car model info
      const carModelSelect = document.getElementById("carModel");
      const carModelText =
        carModelSelect.options[carModelSelect.selectedIndex].text;
      const carVersionSelect = document.getElementById("carVersion");
      const carVersionText =
        carVersionSelect.options[carVersionSelect.selectedIndex].text;

      // Get colors
      const exteriorColorSelect = document.getElementById("exteriorColor");
      const exteriorColorText =
        exteriorColorSelect.options[exteriorColorSelect.selectedIndex].text;

      // Get interior color
      const interiorColorSelect = document.getElementById("interiorColor");
      const interiorColorText = interiorColorSelect && interiorColorSelect.options.length > 0
        ? interiorColorSelect.options[interiorColorSelect.selectedIndex].text
        : "Kh√¥ng c√≥ th√¥ng tin";

      // Get registration location
      const registrationLocationSelect = document.getElementById(
        "registrationLocation"
      );
      const registrationLocationText =
        registrationLocationSelect.options[
          registrationLocationSelect.selectedIndex
        ].text;

      // Get customer info
      const customerName =
        document.getElementById("customerName")?.value || "";
      const customerPhone =
        document.getElementById("customerPhone")?.value || "";
      const customerEmail =
        document.getElementById("customerEmail")?.value || "";
      const customerAddress =
        document.getElementById("customerAddress")?.value || "";
      const customerTypeSelect = document.getElementById("customerType");
      const customerType = customerTypeSelect
        ? customerTypeSelect.value
        : "ca_nhan";

      // Business usage selection (kinh_doanh / khong_kinh_doanh)
      const businessTypeSelect = document.getElementById("businessType");
      const businessType = businessTypeSelect
        ? businessTypeSelect.value
        : "khong_kinh_doanh";
      const depositAmount = parseFloat(
        document.getElementById("depositAmount")?.value || 0
      );
      const depositDate = document.getElementById("depositDate")?.value || "";
      const deliveryDate =
        document.getElementById("deliveryDate")?.value || "";

      // Get car prices
      const basePrice = getCarPrice();
      const discount2 = document.getElementById("discount2").checked
        ? parseFloat(
          document
            .getElementById("discount2")
            .getAttribute("data-discount") || 0
        )
        : 0;
      const discount3 = document.getElementById("discount3").checked
        ? Math.round(basePrice * 0.04)
        : 0;

      // Get VinClub discount
      const vinClubSelect = document.getElementById("vinClubVoucher");
      const vinClubValue = vinClubSelect ? vinClubSelect.value : "none";
      let vinClubDiscount = 0;

  const promotionDiscountTotal = discount2 + discount3;
      const priceAfterBasicPromotions = Math.max(0, basePrice - promotionDiscountTotal);

      if (vinClubValue !== "none" && typeof uu_dai_vin_club !== "undefined") {
        const vinClubData = uu_dai_vin_club.find((item) => item.hang === vinClubValue);
        if (vinClubData) {
          vinClubDiscount = Math.round(priceAfterBasicPromotions * vinClubData.ty_le);
        }
      }

      // Compute convert checkbox data for invoice collection - now treated as discount
      const convertSelected = document.getElementById('convertCheckbox') ? document.getElementById('convertCheckbox').checked : false;
      let convertSupportDiscount = 0;
      if (convertSelected && typeof ho_tro_doi_xe !== 'undefined') {
        try {
          const dongCode = getSelectedDongXe();
          if (dongCode) {
            const entry = ho_tro_doi_xe.find(h => h.dong_xe === dongCode);
            if (entry && entry.gia_tri) convertSupportDiscount = Number(entry.gia_tri) || 0;
          }
        } catch (e) {
          console.warn('collectInvoiceData: error computing convert support', e);
        }
      }

      const totalDiscount = promotionDiscountTotal + vinClubDiscount + convertSupportDiscount;
      const priceAfterDiscount = Math.max(0, basePrice - totalDiscount);

      // Get on-road costs
      const registrationLocation = document.getElementById(
        "registrationLocation"
      ).value;

      const locationKey = locationMap[registrationLocation] || "tinh_khac";

      // Get fees from database
      const plateFeeData =
        typeof phi_cap_bien_so !== "undefined"
          ? phi_cap_bien_so.find((item) => item.khu_vuc === locationKey)
          : null;
      const plateFee = plateFeeData ? plateFeeData.gia_tri : 20000000;

      const roadFeeData =
        typeof phi_duong_bo !== "undefined"
          ? phi_duong_bo.find((item) => item.loai === customerType)
          : null;
      const roadFee = roadFeeData ? roadFeeData.gia_tri : 1560000;

      // Get car model key
      const carModelKey = getCurrentCarModel();
      const carInfo =
        typeof thong_tin_ky_thuat_xe !== "undefined"
          ? thong_tin_ky_thuat_xe.find((item) => item.dong_xe === carModelKey)
          : null;

      const liabilityInsurance = carInfo
        ? businessType === "khong_kinh_doanh"
          ? carInfo.phi_tnds_ca_nhan
          : carInfo.phi_tnds_kinh_doanh
        : 480700;

      const inspectionFee =
        typeof phi_kiem_dinh !== "undefined" ? phi_kiem_dinh : 90000;

      const bhvcRate = carInfo
        ? businessType === "khong_kinh_doanh"
          ? carInfo.ty_le_bhvc_ca_nhan
          : carInfo.ty_le_bhvc_kinh_doanh
        : 0.015;
      const bodyInsurance = Math.round(priceAfterDiscount * bhvcRate);

      const registrationFee =
        typeof chi_phi_dich_vu_dang_ky !== "undefined"
          ? chi_phi_dich_vu_dang_ky
          : 3900000;

      const totalOnRoadCost =
        plateFee +
        roadFee +
        liabilityInsurance +
        inspectionFee +
        bodyInsurance +
        registrationFee;
      const grandTotal = priceAfterDiscount + totalOnRoadCost;

      // Get loan info
      const hasLoan = document.getElementById("loanToggle").checked;
      let loanData = {};
      if (hasLoan) {
        const loanRatio = parseFloat(
          document.getElementById("loanRatio").value
        );
        const loanTerm = parseInt(document.getElementById("loanTerm").value);
        // choose interest rate from custom input
        let annualRate = typeof lai_suat_vay_hang_nam !== "undefined" ? lai_suat_vay_hang_nam : 0.095;
        try {
          const customRateEl = document.getElementById('customInterestRate');
          const custom = customRateEl && customRateEl.value ? Number(customRateEl.value) / 100 : null;
          if (custom && !isNaN(custom) && custom >= 0) {
            annualRate = custom;
          }
        } catch (e) {
          // fallback to default
        }
        const monthlyRate = annualRate / 12;

        const loanAmount = Math.round((priceAfterDiscount + totalOnRoadCost) * (loanRatio / 100));
        const downPayment = (priceAfterDiscount + totalOnRoadCost) - loanAmount;

        const monthlyPayment =
          (loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, loanTerm))) /
          (Math.pow(1 + monthlyRate, loanTerm) - 1);
        const totalPayment = monthlyPayment * loanTerm;
        const totalInterest = totalPayment - loanAmount;

        loanData = {
          loanRatio: loanRatio,
          loanTerm: loanTerm,
          interestRate: annualRate,
          downPayment: downPayment,
          loanAmount: loanAmount,
          totalInterest: Math.round(totalInterest),
          monthlyPayment: Math.round(monthlyPayment),
        };
      }

      // Generate invoice number
      const now = new Date();
      const invoiceNo = `VF-${now.getFullYear()}-${String(
        now.getMonth() + 1
      ).padStart(2, "0")}${String(now.getDate()).padStart(2, "0")}-${String(
        Math.floor(Math.random() * 10000)
      ).padStart(4, "0")}`;

      // Return complete data object
      return {
        invoiceNo: invoiceNo,
        invoiceDate: now.toISOString(),
        customerName: customerName,
        customerPhone: customerPhone,
        customerEmail: customerEmail,
        customerAddress: customerAddress,
  customerType: customerType,
  businessType: businessType,
        depositAmount: depositAmount,
        depositDate: depositDate,
        deliveryDate: deliveryDate,
        carModel: carModelText,
        carVersion: carVersionText,
        exteriorColor: exteriorColorText,
        interiorColor: interiorColorText,
        registrationLocation: registrationLocationText,
        carBasePrice: basePrice,
        carDiscount: totalDiscount,
        carPriceAfterPromotions: priceAfterBasicPromotions,
        carTotal: priceAfterDiscount,
        plateFee: plateFee,
        plateLocation: registrationLocationText,
        roadFee: roadFee,
        liabilityInsurance: liabilityInsurance,
        inspectionFee: inspectionFee,
        bodyInsurance: bodyInsurance,
        bodyInsuranceRate: bhvcRate,
        registrationFee: registrationFee,
        convertSelected: convertSelected,
        convertSupportDiscount: convertSupportDiscount,
        totalOnRoadCost: totalOnRoadCost,
        grandTotal: grandTotal,
        hasLoan: hasLoan,
        ...loanData,
      };
    }

    // Print quote buttons - Save data and redirect to invoice page
    function handlePrintQuote() {
      const invoiceData = collectInvoiceData();

      // Save to localStorage
      localStorage.setItem("invoiceData", JSON.stringify(invoiceData));

      // Redirect to invoice page
      window.location.href = "invoice.html";
    }

    // Print Quote 2 Button - redirect to invoice2.html
    function handlePrintQuote2() {
      const invoiceData = collectInvoiceData();

      // Save to localStorage
      localStorage.setItem("invoiceData", JSON.stringify(invoiceData));

      // Redirect to invoice2 page
      window.location.href = "invoice2.html";
    }

    // Email quote buttons
    function sendEmail() {
      alert("T√≠nh nƒÉng g·ª≠i email b√°o gi√° s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai s·ªõm!");
    }
    // Only bind to footer button
    document
      .getElementById("emailBtnFooter")
      .addEventListener("click", sendEmail);

    // Bind print buttons to their handlers
    const printBtn = document.getElementById("printBtnFooter");
    if (printBtn) printBtn.addEventListener("click", handlePrintQuote);

    const printBtn2 = document.getElementById("printBtn2Footer");
    if (printBtn2) printBtn2.addEventListener("click", handlePrintQuote2);

    // ============================================
    // INITIALIZATION FUNCTION - AUTO LOAD DATA
    // ============================================
    function initializeApp() {
      console.log("üöÄ Initializing VinFast Calculator...");

      try {
        // Set default dates
        const today = new Date();
        const depositDate = new Date(today);
        depositDate.setDate(today.getDate() + 5);
        const deliveryDate = new Date(today);
        deliveryDate.setMonth(today.getMonth() + 1);

        const depositEl = document.getElementById("depositDate");
        const deliveryEl = document.getElementById("deliveryDate");
        if (depositEl) depositEl.valueAsDate = depositDate;
        if (deliveryEl) deliveryEl.valueAsDate = deliveryDate;

        // Build derivedVersions from carPriceData if available
        if (typeof carPriceData !== 'undefined' && Array.isArray(carPriceData)) {
          try {
            derivedVersions = buildDerivedVersionsFromCarPriceData();
            console.log("DEBUG: built derivedVersions from carPriceData, count=", derivedVersions.length);
          } catch (e) {
            console.error("ERROR building derivedVersions:", e);
          }
        } else {
          console.warn('carPriceData not available; no car data loaded');
        }

        // Populate UI selects from derived data (if any)
        const defaultModel = populateCarModels();
        console.log('Selected default model:', defaultModel);
        populateCarVersions(defaultModel || (derivedVersions[0] && derivedVersions[0].model) || '', false);

        // Update deposit amount for initial selection
        updateDepositAmount();

        // Initial calculation
        calculateAll();

        console.log("‚ú® Initialization complete!");
      } catch (error) {
        console.error("‚ùå Error during initialization:", error);
      }
    }

    // Run initialization when page loads
    window.addEventListener("DOMContentLoaded", function () {
      console.log("üìÑ DOM Content Loaded");
      // Small delay to ensure database.js is fully loaded
      setTimeout(initializeApp, 50);
    });

    // Fallback: Also try on window.load
    window.addEventListener("load", function () {
      console.log("üåê Window Loaded");
      // Check if already initialized
      if (document.getElementById("carModel").options.length === 0) {
        console.log("üîÑ Retrying initialization...");
        setTimeout(initializeApp, 100);
      }
    });

    // Handle window resize
    window.addEventListener("resize", function () {
      if (window.innerWidth >= 1024 && !localStorage.getItem("mobileView")) {
        document.body.classList.remove("mobile-view");
        viewToggle.textContent = "üì± Mobile View";
      } else if (window.innerWidth < 1024) {
        document.body.classList.add("mobile-view");
        viewToggle.textContent = "üñ•Ô∏è Desktop View";
      }
    });
  </script>

  <!-- Swiper JS removed (image modal disabled) -->

  <!-- Initialize App After Database Loaded -->
  <script>
    // Check if database is loaded
    console.log(
      "üîç Checking metadata...",
      typeof vinfast_images_metadata !== "undefined" ? "‚úÖ Loaded" : "‚ùå Not loaded"
    );
    console.log(
      "üîç Checking car price data...",
      carPriceData
    );
  </script>

  <!-- Image modal script removed (image UI disabled) -->
</body>

</html>